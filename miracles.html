<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sai Baba Spiritual Portal</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Philosopher&display=swap" rel="stylesheet">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%); min-height: 100vh; }
    
    .site-header { background: #8e24aa; color: white; padding: 1rem 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
    .header-inner { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
    .brand { font-size: 1.5rem; font-weight: 600; color: white; text-decoration: none; }
    .main-nav { display: flex; gap: 1.5rem; flex-wrap: wrap; }
    .main-nav a { color: white; text-decoration: none; transition: opacity 0.3s; }
    .main-nav a:hover, .main-nav a.active { opacity: 0.8; text-decoration: underline; }
    
    .miracle-container { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; max-width: 1400px; margin: 2rem auto; padding: 0 20px; }
    
    .form-section, .stories-section { background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    
    .form-section h1 { color: #8e24aa; margin-bottom: 0.5rem; }
    .form-section p { color: #666; margin-bottom: 1.5rem; }
    
    form input, form select, form textarea { width: 100%; padding: 0.8rem; margin-bottom: 1rem; border: 2px solid #ddd; border-radius: 8px; font-family: 'Poppins', sans-serif; font-size: 1rem; }
    form input:focus, form select:focus, form textarea:focus { outline: none; border-color: #8e24aa; }
    
    form button { width: 100%; padding: 1rem; background: #8e24aa; color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: background 0.3s; }
    form button:hover { background: #7b1fa2; }
    form button:disabled { background: #ccc; cursor: not-allowed; }
    
    #status { text-align: center; margin-top: 1rem; font-weight: 600; color: #4caf50; }
    
    .stories-section h2 { color: #8e24aa; margin-bottom: 1.5rem; text-align: center; }
    
    .story-card { background: #f9f9f9; padding: 1.5rem; border-radius: 10px; margin-bottom: 1rem; border-left: 4px solid #8e24aa; transition: all 0.3s ease; }
    .story-card:hover { transform: translateX(5px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .story-card h3 { color: #8e24aa; margin-bottom: 0.5rem; font-size: 1.1rem; }
    .story-card span { color: #999; font-size: 0.85rem; display: block; margin-bottom: 0.8rem; }
    .story-card p { color: #555; line-height: 1.6; }
    
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #8e24aa; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 2rem auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .site-footer { background: #8e24aa; color: white; padding: 2rem 0; text-align: center; margin-top: 3rem; }
    .disclaimer { font-size: 0.85rem; opacity: 0.8; margin-top: 1rem; }
    
    .live-indicator { display: inline-block; width: 8px; height: 8px; background: #4caf50; border-radius: 50%; margin-right: 5px; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    @media (max-width: 768px) {
      .miracle-container { grid-template-columns: 1fr; }
      .header-inner { flex-direction: column; gap: 1rem; }
      .main-nav { justify-content: center; }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="site-header">
    <div class="container header-inner">
      <a href="index.html" class="brand">ðŸŒ¸ Sai Baba Portal ðŸŒ¸</a>
      <nav class="main-nav">
        <a href="index.html">Home</a>
        <a href="teachings.html">Teachings</a>
        <a href="chits.html">Chits</a>
        <a href="daily-quote.html">Daily Quote</a>
        <a href="Worship.html">Worship</a>
        <a href="miracles.html" class="active">Miracles</a>
        <a href="Contact.html">Contact</a>
      </nav>
    </div>
  </header>

  <div class="miracle-container">
    <!-- Right: Form -->
    <div class="form-section">
      <h1>Share Your Miracle Story</h1>
      <p>Share your Sai Baba miracle and inspire others with His divine blessings.</p>

      <form id="miracleForm">
        <input type="text" name="entry.579044948" placeholder="Your Name" required>
        <select name="entry.964793499" required>
          <option value="">Select Category</option>
          <option value="Health">Health</option>
          <option value="Job">Job</option>
          <option value="Family">Family</option>
          <option value="Wealth">Wealth</option>
          <option value="Marriage">Marriage</option>
          <option value="Business">Business</option>
          <option value="Education">Education</option>
          <option value="Children">Children</option>
          <option value="Wish Fulfilled">Wish Fulfilled</option>
          <option value="Protection">Protection</option>
          <option value="Relationship">Relationship</option>
          <option value="Other">Other</option>
        </select>
        <textarea name="entry.1663738702" placeholder="Share your story..." rows="5" required></textarea>
        <button type="submit">Submit Story</button>
        <p id="status"></p>
        <p style="font-size:0.9rem; color:#8e24aa; margin-top:12px; text-align:center;">
          âœ¨ Your story may be the blessing someone else needs today. âœ¨
        </p>
      </form>
    </div>


    <!-- Left: Stories -->
    <div class="stories-section" id="stories">
      <h2><span class="live-indicator"></span>Submitted Stories (Live)</h2>
      <div id="storiesContainer">
        <div class="loader"></div>
      </div>

      <p style="font-style: italic; color:#5b3c11; text-align:center; margin-bottom:15px;">
        Read the divine experiences shared by fellow devotees. May these stories strengthen your faith and bring peace to your heart.
      </p>
    </div>
  </div>

<script>
const form = document.getElementById('miracleForm');
const status = document.getElementById('status');
const storiesContainer = document.getElementById('storiesContainer');
const storiesSection = document.getElementById('stories');

const googleFormAction = "https://docs.google.com/forms/d/e/1FAIpQLSc67HpyGedHobqRiVFJNhZ-TC8m-KtLVhiHeiBFV65j4W5SNg/formResponse";
const appScriptURL = "https://script.google.com/macros/s/AKfycbxEMxINPnuddrqy72-FXAyVRyTW5I-UjvnEYlFuHslNuId6jUC5RqXg9Kdgvmm2B1DCJw/exec";

const CACHE_KEY = "sai_baba_stories";
let lastKnownCount = 0;

function displayStories(data) {
  storiesContainer.innerHTML = "";
  if (!data.length) {
    storiesContainer.innerHTML = "<p>No stories yet.</p>";
    return;
  }

  const reversed = [...data].reverse();
  reversed.forEach((story, index) => {
    const name = story.Name || story.name || story["entry.579044948"] || "Anonymous";
    const category = story.Category || story.category || story["entry.964793499"] || "Other";
    const storyText = story.Story || story.storyText || story["entry.1663738702"] || "";
    const timestamp = story.Timestamp || story.timestamp || story.time || new Date().toISOString();

    const div = document.createElement('div');
    div.classList.add('story-card');
    
    // Highlight new stories
    if (index === 0 && data.length > lastKnownCount) {
      div.style.background = '#e1f5e1';
      setTimeout(() => {
        div.style.background = '#f9f9f9';
        div.style.transition = 'background 2s ease';
      }, 100);
    }
    
    div.innerHTML = `
      <h3>${name} (${category})</h3>
      <span>${new Date(timestamp).toLocaleString()}</span>
      <p>${storyText}</p>
    `;
    storiesContainer.appendChild(div);
  });
  
  lastKnownCount = data.length;
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const submitButton = form.querySelector('button');
  submitButton.disabled = true;
  status.textContent = "Submitting...";

  const data = new FormData(form);
  
  // Extract form data for immediate display
  const name = data.get("entry.579044948");
  const category = data.get("entry.964793499");
  const storyText = data.get("entry.1663738702");
  
  // Create optimistic story object
  const newStory = {
    Name: name,
    Category: category,
    Story: storyText,
    Timestamp: new Date().toISOString()
  };

  // Immediately add to display (optimistic update)
  const currentStories = JSON.parse(localStorage.getItem(CACHE_KEY) || "[]");
  currentStories.push(newStory);
  localStorage.setItem(CACHE_KEY, JSON.stringify(currentStories));
  displayStories(currentStories);
  
  form.reset();
  status.textContent = "âœ¨ Story submitted successfully!";
  storiesSection.scrollIntoView({ behavior: 'smooth' });

  // Submit to Google Form in background
  const params = new URLSearchParams();
  for (const [key, value] of data) params.append(key, value);
  fetch(googleFormAction, { method: 'POST', mode: 'no-cors', body: params });

  // Force immediate sync
  setTimeout(() => {
    pollForUpdates();
  }, 1500);
  
  submitButton.disabled = false;
});

async function pollForUpdates() {
  try {
    const response = await fetch(appScriptURL + '?t=' + Date.now(), { 
      cache: "no-cache",
      headers: { 'Cache-Control': 'no-cache' }
    });
    const data = await response.json();
    
    const cached = localStorage.getItem(CACHE_KEY);
    const cachedData = cached ? JSON.parse(cached) : [];
    
    // Only update if server has more stories
    if (data.length >= cachedData.length) {
      localStorage.setItem(CACHE_KEY, JSON.stringify(data));
      displayStories(data);
    }
  } catch (err) {
    console.error("Poll error:", err);
  }
}

// REAL-TIME POLLING - Checks every 3 seconds for new stories
let pollingInterval;

function startPolling() {
  // Clear any existing interval
  if (pollingInterval) clearInterval(pollingInterval);
  
  // Poll every 3 seconds when page is visible
  pollingInterval = setInterval(() => {
    if (document.visibilityState === 'visible') {
      pollForUpdates();
    }
  }, 3000);
}

// Stop polling when page is hidden (save bandwidth)
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible') {
    pollForUpdates();
    startPolling();
  } else {
    if (pollingInterval) clearInterval(pollingInterval);
  }
});

// Initial load - show cache immediately, then poll
(function init() {
  console.log("ðŸš€ Initializing real-time updates...");
  
  const cached = localStorage.getItem(CACHE_KEY);
  if (cached) {
    displayStories(JSON.parse(cached));
  } else {
    storiesContainer.innerHTML = '<div class="loader"></div>';
  }
  
  // Fetch immediately
  pollForUpdates();
  
  // Start continuous polling
  startPolling();
})();
</script>

  <!-- Footer -->
  <footer class="site-footer">
    <p>Â© 2025 Sai Baba Spiritual Portal. All rights reserved.</p>
    <p class="disclaimer">
      Disclaimer: The content on this website is for informational and spiritual guidance purposes only. 
      It is based on public domain sources and does not claim ownership of copyrighted materials.
    </p>
  </footer>
</body>
</html>
