<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sai Baba Spiritual Portal</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Philosopher&display=swap" rel="stylesheet">

  <!-- CSS -->
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <!-- Header -->
  <header class="site-header">
    <div class="container header-inner">
      <a href="index.html" class="brand">üå∏ Sai Baba Portal üå∏</a>
      <nav class="main-nav">
        <a href="index.html">Home</a>
        <a href="teachings.html">Teachings</a>
        <a href="chits.html">Chits</a>
        <a href="daily-quote.html">Daily Quote</a>
        <a href="Worship.html">Worship</a>
        <a href="miracles.html" class="active">Miracles</a>
        <a href="Contact.html">Contact</a>
      </nav>
    </div>
  </header>

  <div class="miracle-container">
    <!-- Right: Form -->
    <div class="form-section">
      <h1>Share Your Miracle Story</h1>
      <p>Share your Sai Baba miracle and inspire others with His divine blessings.</p>

      <form id="miracleForm">
        <input type="text" name="entry.579044948" placeholder="Your Name" required>
        <select name="entry.964793499" required>
          <option value="">Select Category</option>
          <option value="Health">Health</option>
          <option value="Health">Job</option>
          <option value="Family">Family</option>
          <option value="Wealth">Wealth</option>
          <option value="Marriage">Marriage</option>
          <option value="Business">Business</option>
          <option value="Education">Education</option>
          <option value="Children">Children</option>
          <option value="Wish Fulfilled">Wish Fulfilled</option>
          <option value="Protection">Protection</option>
          <option value="Relationship">Relationship</option>
          <option value="Other">Other</option>
        </select>
        <textarea name="entry.1663738702" placeholder="Share your story..." rows="5" required></textarea>
        <button type="submit">Submit Story</button>
        <p id="status"></p>
        <p style="font-size:0.9rem; color:#8e24aa; margin-top:12px; text-align:center;">
          ‚ú® Your story may be the blessing someone else needs today. ‚ú®
        </p>
      </form>
    </div>


    <!-- Left: Stories -->
    <div class="stories-section" id="stories">
      <h2>Submitted Stories</h2>
      <div id="storiesContainer">
        <div class="loader"></div>
      </div>

      <p style="font-style: italic; color:#5b3c11; text-align:center; margin-bottom:15px;">
        Read the divine experiences shared by fellow devotees. May these stories strengthen your faith and bring peace to your heart.
      </p>
    </div>
  </div>

<script>
const form = document.getElementById('miracleForm');
const status = document.getElementById('status');
const storiesContainer = document.getElementById('storiesContainer');
const storiesSection = document.getElementById('stories');

const googleFormAction = "https://docs.google.com/forms/d/e/1FAIpQLSc67HpyGedHobqRiVFJNhZ-TC8m-KtLVhiHeiBFV65j4W5SNg/formResponse";
const appScriptURL = "https://script.google.com/macros/s/AKfycbxEMxINPnuddrqy72-FXAyVRyTW5I-UjvnEYlFuHslNuId6jUC5RqXg9Kdgvmm2B1DCJw/exec";

const CACHE_KEY = "sai_baba_stories";
const CACHE_TIMESTAMP_KEY = "sai_baba_stories_timestamp";
const CACHE_DURATION = 60000; // 1 minute cache

function displayStories(data) {
  storiesContainer.innerHTML = "";
  if (!data.length) {
    storiesContainer.innerHTML = "<p>No stories yet.</p>";
    return;
  }

  data.reverse().forEach(story => {
    const name = story.Name || story.name || story["entry.579044948"] || "Anonymous";
    const category = story.Category || story.category || story["entry.964793499"] || "Other";
    const storyText = story.Story || story.storyText || story["entry.1663738702"] || "";
    const timestamp = story.Timestamp || story.timestamp || story.time || new Date().toISOString();

    const div = document.createElement('div');
    div.classList.add('story-card');
    div.style.opacity = 0;
    div.style.transform = "translateY(-10px)";
    div.innerHTML = `
      <h3>${name} (${category})</h3>
      <span>${new Date(timestamp).toLocaleString()}</span>
      <p>${storyText}</p>
    `;
    storiesContainer.appendChild(div);
    requestAnimationFrame(() => {
      div.style.opacity = 1;
      div.style.transform = "translateY(0)";
    });
  });
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const submitButton = form.querySelector('button');
  submitButton.disabled = true;
  status.textContent = "Submitting...";

  const data = new FormData(form);
  
  // Extract form data for immediate display
  const name = data.get("entry.579044948");
  const category = data.get("entry.964793499");
  const storyText = data.get("entry.1663738702");
  
  // Create optimistic story object
  const newStory = {
    Name: name,
    Category: category,
    Story: storyText,
    Timestamp: new Date().toISOString()
  };

  // Immediately add to display (optimistic update)
  const currentStories = JSON.parse(localStorage.getItem(CACHE_KEY) || "[]");
  currentStories.push(newStory);
  localStorage.setItem(CACHE_KEY, JSON.stringify(currentStories));
  displayStories(currentStories);
  
  form.reset();
  status.textContent = "‚ú® Story submitted successfully!";
  storiesSection.scrollIntoView({ behavior: 'smooth' });

  // Submit to Google Form in background
  const params = new URLSearchParams();
  for (const pair of data) params.append(pair[0], pair[1]);
  fetch(googleFormAction, { method: 'POST', mode: 'no-cors', body: params });

  // Fetch fresh data after 2 seconds to sync with server
  setTimeout(() => {
    fetchStories(true, false);
  }, 2000);
  
  submitButton.disabled = false;
});

async function fetchStories(forceRefresh = false, showLoader = false) {
  const now = Date.now();
  const lastFetch = parseInt(sessionStorage.getItem(CACHE_TIMESTAMP_KEY) || '0');
  const cached = localStorage.getItem(CACHE_KEY);

  // Use cache if it's fresh and not forcing refresh
  if (!forceRefresh && cached && (now - lastFetch < CACHE_DURATION)) {
    console.log("‚úÖ Using cached stories");
    displayStories(JSON.parse(cached));
    return;
  }

  if (showLoader) storiesContainer.innerHTML = '<div class="loader"></div>';
  
  try {
    console.log("üîÑ Fetching fresh stories from Google Sheets...");
    const response = await fetch(appScriptURL + '?t=' + now, { cache: "no-cache" });
    const data = await response.json();
    console.log("‚úÖ Fetched", data.length, "stories");
    
    if (data.length > 0) {
      localStorage.setItem(CACHE_KEY, JSON.stringify(data));
      sessionStorage.setItem(CACHE_TIMESTAMP_KEY, now.toString());
      displayStories(data);
      status.textContent = "";
    } else if (cached) {
      console.log("‚ö†Ô∏è No data from server, using cache");
      displayStories(JSON.parse(cached));
    }
  } catch (err) {
    console.error("‚ùå Failed to fetch stories:", err);
    if (cached) {
      console.log("‚ö†Ô∏è Using cached stories due to error");
      displayStories(JSON.parse(cached));
    } else {
      storiesContainer.innerHTML = "<p>Unable to load stories. Please refresh the page.</p>";
    }
    status.textContent = "";
  }
}

// Initial load - show cache immediately, then update
(function init() {
  console.log("üöÄ Initializing page...");
  
  const cached = localStorage.getItem(CACHE_KEY);
  if (cached) {
    // Show cached stories instantly
    console.log("‚ö° Displaying cached stories immediately");
    displayStories(JSON.parse(cached));
    // Then fetch fresh data in background
    fetchStories(true, false);
  } else {
    // No cache, show loader and fetch
    fetchStories(true, true);
  }
})();

// Auto-refresh every 30 seconds when page is visible
setInterval(() => {
  if (document.visibilityState === 'visible') {
    fetchStories(true, false);
  }
}, 30000);
</script>

  <!-- Footer -->
  <footer class="site-footer">
    <p>¬© 2025 Sai Baba Spiritual Portal. All rights reserved.</p>
    <p class="disclaimer">
      Disclaimer: The content on this website is for informational and spiritual guidance purposes only. 
      It is based on public domain sources and does not claim ownership of copyrighted materials.
    </p>
  </footer>
</body>
</html>

